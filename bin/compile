#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# Write debug info to a file in the build dir
echo "-----> Debug: AppSignal buildpack compile script starting at $(date)" > "$1/appsignal-buildpack-compile.log"
echo "-----> Debug: Build dir is $1" >> "$1/appsignal-buildpack-compile.log"
echo "-----> Debug: Cache dir is $2" >> "$1/appsignal-buildpack-compile.log"
echo "-----> Debug: Env dir is $3" >> "$1/appsignal-buildpack-compile.log"
echo "-----> Debug: Current directory is $(pwd)" >> "$1/appsignal-buildpack-compile.log"
echo "-----> Debug: Environment variables:" >> "$1/appsignal-buildpack-compile.log"
env >> "$1/appsignal-buildpack-compile.log"

# Fail fast
set -e
set -o pipefail

# Debug
set -x

# Parse params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Set buildpack dir
BUILDPACK_DIR=$(cd "$(dirname "$0")"; cd ..; pwd)

# Check for required environment variable
if [ ! -f "$ENV_DIR/APPSIGNAL_PUSH_API_KEY" ]; then
  echo "-----> Error: APPSIGNAL_PUSH_API_KEY environment variable is required"
  echo "      Please set it in your Heroku config vars"
  echo "      You can find your Push API key in the 'Push & Deploy' section of your AppSignal dashboard"
  exit 1
fi

# Read the API key from ENV_DIR
APPSIGNAL_PUSH_API_KEY=$(cat "$ENV_DIR/APPSIGNAL_PUSH_API_KEY")

echo "-----> Configuring AppSignal collector"

# Configure the collector
cat << EOF > /etc/appsignal-collector.conf
# AppSignal collector configuration
# Generated by Heroku buildpack
push_api_key = "${APPSIGNAL_PUSH_API_KEY}"
EOF

# Install the runner
echo "-----> Installing AppSignal Collector runner"
mkdir -p "$BUILD_DIR/.profile.d"
cp "$BUILDPACK_DIR/extra/appsignal.sh" "$BUILD_DIR/.profile.d/"
chmod +x "$BUILD_DIR/.profile.d/appsignal.sh"

echo "-----> AppSignal collector setup complete"
echo "-----> Collector will start automatically in the background when the dyno starts"
